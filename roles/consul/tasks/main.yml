---
#Setup yum files
- include_role: name=yum-repo

- name: Install consul
  yum: name=consul-{{ consul.version }} state=present

- name: create link
  file:
    src: /etc/consul/server.json
    dest: /etc/consul/config.json
    state: link

- name: replace with real ip addr
  replace:
    path: /etc/consul/config.json
    regexp: '"advertise_addr" : "IP",'
    replace: '"advertise_addr" : "{{ ansible_default_ipv4.address }}",'

- name: overwrite startup option
  file:
    dest: "/etc/sysconfig/consul"
    src: "consul"
    owner: root
    group: root
    mode: 0644

- name: Check consul running
  service: name=consul state=started enabled=true

- include_role: name=nginx

- name: Creates a cron file under /etc/cron.d to backup db
  cron:
    name: consul backup daily
    weekday: '*'
    minute: "30"
    hour: "0"
    user: root
    job: "consul snapshot save /etc/consul/backup.snap"


- include_role: name=sensu-client

- include_role: name=filebeat
